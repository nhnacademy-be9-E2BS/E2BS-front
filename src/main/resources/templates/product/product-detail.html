<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layouts/user-layout}">

<style>
	.product_count {
		display: flex;
		align-items: center;
		gap: 10px;
	}

	.product_count label {
		font-weight: bold;
	}

	.input-text.qty {
		width: 60px;
		padding: 5px;
		text-align: center;
		border: 1px solid #ccc;
		border-radius: 4px;
	}

	.increase, .reduced {
		background-color: #f5f5f5;
		border: 1px solid #ccc;
		border-radius: 4px;
		padding: 5px 10px;
		cursor: pointer;
	}

	.increase:hover, .reduced:hover {
		background-color: #e0e0e0;
	}

	.increase i, .reduced i {
		font-size: 14px;
	}

	.image-slider{
		position: relative;
		width: 500px !important;
		height: 680px !important; /* 이미지 세로 크기 */
		overflow: hidden;
	}

	.slider-container {
		position: relative;
		width: 100%;
		height: 100%;
	}

	.slides {
		position: relative;
		width: 100%;
		height: 100%;
	}

	.slide {
		display: none;
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.slide.active {
		display: block;
	}

	.prev, .next {
		position: absolute;
		top: 50%;
		transform: translateY(-50%);
		background-color: rgba(0, 0, 0, 0.5);
		color: white;
		border: none;
		padding: 10px;
		cursor: pointer;
		font-size: 18px;
	}

	.prev {
		left: 0;
	}

	.next {
		right: 0;
	}

	.prev:hover, .next:hover {
		background-color: rgba(0, 0, 0, 0.8);
	}

	.prev:disabled, .next:disabled {
		background-color: rgba(0, 0, 0, 0.3);
		cursor: not-allowed;
	}

</style>
<body>
<div layout:fragment="content">
	<!-- 상품 이미지 및 상세 -->
	<section class="product_image_area section-padding">
		<div class="container">
			<!-- 상품 이미지-->
			<div class="row s_product_inner">
				<div class="col-lg-6">
					<div class="card-detail-img">
						<div class="image-slider" th:if="${product.productImagePaths != null and !#lists.isEmpty(product.productImagePaths)}">
							<div class="slider-container">
								<div class="slides">
									<img th:each="image, iterStat : ${product.productImagePaths}"
										 th:src="${image.productImagePath}"
										 th:alt="${product.productTitle} + ' 이미지 ' + ${iterStat.count}"
										 class="slide" th:classappend="${iterStat.first} ? 'active' : ''"
										 onerror="this.src='https://via.placeholder.com/110x150?text=No+Image'"
										 style="width: 500px; height: 680px;">
								</div>
								<button class="prev" onclick="changeSlide(-1)" th:disabled="${product.productImagePaths.size() <= 1}">❮</button>
								<button class="next" onclick="changeSlide(1)" th:disabled="${product.productImagePaths.size() <= 1}">❯</button>
							</div>
						</div>
						<div th:if="${product.productImagePaths == null or #lists.isEmpty(product.productImagePaths)}">
							<img src="https://via.placeholder.com/110x150?text=No+Image"
								 th:alt="${product.productTitle} + ' 표지 이미지'"
								 style="width: 500px; height: 680px;">
						</div>
					</div>
				</div>
				<!-- 상품 정보 -->
				<div class="col-lg-5 offset-lg-1">
					<div class="s_product_text card-product" th:data-product-id = "${product.productId}">
						<!--상품 제목-->
						 <h3 th:text="${product.productTitle}"></h3>
						<!-- 출판사, 가여자(역할) -->
						<div>
							<h6>
								<span th:text="${product.publisher.publisherName}"></span> /
								<span th:each="contributor, stat : ${product.contributors}">
								<span th:text="|${contributor.contributorName} (${contributor.positionName})|" />
								<span th:unless="${stat.last}" th:text="', '" />
								</span>
							</h6>
						</div>
						<!-- 가격 -->

						<h2 th:text="${#numbers.formatInteger(product.productSalePrice, 0, 'COMMA')} + '원'"></h2>

						<ul class="list">
							<!-- 재고 -->
							<li>
								<span>재고</span> :
								<span th:text="${product.productStock} + ' 개'"></span>
							</li>
						</ul>
						<div class="product_count">
							<label for="quantity">수량:</label>
							<input type="number" name="qty" id="quantity"
								   th:value="${product.productStock > 0 ? 1 : 0}"
								   title="수량"
								   class="input-text qty"
								   min="0"
								   th:max="${product.productStock}"
								   oninput="validateQuantity()" />
							<button type="button" class="increase" onclick="adjustQuantity(1)"><i class="lnr lnr-chevron-up"></i></button>
							<button type="button" class="reduced" onclick="adjustQuantity(-1)"><i class="lnr lnr-chevron-down"></i></button>
						</div>
						<div class="button-container">
							<!-- 장바구니 추가 -->
							<button class="add-cart-btn"
									style="display: inline-block;min-width: 180px;padding: 12px 32px;font-size: 18px;font-weight: 600;border: 2px solid transparent;border-radius: 999px;background: #2d4fff;color: #fff;cursor: pointer;transition: background 0.2s, color 0.2s, border 0.2s;">
								장바구니에 추가</button>
							<button class="buy-now-btn custom-btn"
									onclick="submitOrder()"
									style="display: inline-block;min-width: 180px;padding: 12px 32px;font-size: 18px;font-weight: 600;border: 2px solid transparent;border-radius: 999px;background: #2d4fff;color: #fff;cursor: pointer;transition: background 0.2s, color 0.2s, border 0.2s;">
								바로구매</button>
						</div>
						<div class="product_meta mt-3">
<!--							<p><strong>ISBN:</strong> 9780393317558</p>-->
							<!-- Thymeleaf로 변경 시: -->
							 <p><strong>ISBN:</strong> <span th:text="${product.productIsbn}"></span></p>

<!--							<p><strong>출판사:</strong> W. W. Norton & Company</p>-->
							<!-- Thymeleaf로 변경 시: -->
<!--							 <p><strong>출판사:</strong> <span th:text="${product.publisherName}"></span></p>-->

<!--							<p><strong>기여자:</strong> Jared Diamond</p>-->
							<!-- Thymeleaf로 변경 시: -->
							<!-- <p><strong>기여자:</strong> -->
							<!--     <span th:unless="${product.contributorNames.isEmpty()}" th:text="${#strings.join(product.contributorNames, ', ')}"></span> -->
							<!--     <span th:if="${product.contributorNames.isEmpty()}">미지정</span> -->
							<!-- </p> -->

<!--							<p><strong>태그:</strong> 퓰리처상, 지리적 결정론, 문명사</p>-->
							<!-- Thymeleaf로 변경 시: -->
<!--							 <p><strong>태그:</strong>-->
<!--							     <span th:unless="${product.tagNames.isEmpty()}" th:text="${#strings.join(product.tagNames, ', ')}"></span>-->
<!--							     <span th:if="${product.tagNames.isEmpty()}">미지정</span>-->
							 </p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
	<!-- 상품 상세 탭 -->
	<section class="product_description_area">
		<div class="container">
			<ul class="nav nav-tabs" id="myTab" role="tablist">
				<li class="nav-item">
					<a class="nav-link active" id="description-tab" data-toggle="tab" href="#description" role="tab" aria-controls="description" aria-selected="true">설명</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" id="review-tab" data-toggle="tab" href="#review" role="tab" aria-controls="review" aria-selected="false">리뷰</a>
				</li>
			</ul>
			<div class="tab-content" id="myTabContent">
				<!-- 설명 -->
				<div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab">
					<!-- Thymeleaf로 변경 시 (목차는 productContent로 가정): -->
					 <h4>목차</h4>
					 <ul>
					     <li th:utext="${product.productContent}"></li>
					 </ul>

<!--					*총균쇠*는 인류 문명의 발달 차이를 설명하는 획기적인 저서로, 지리적·환경적 요인이 문명의 성공과 패배를 결정했다고 주장합니다. 유라시아의 농업 혁명, 병균 저항력, 기술 발전이 어떻게 다른 대륙을 압도했는지 탐구하며, 인종적 우월성 이론을 반박합니다. 퓰리처상을 수상한 이 책은 역사, 인류학, 생물학을 융합한 대중 과학의 걸작입니다.-->
					<!-- Thymeleaf로 변경 시: -->
					 <h4 class="mt-4">상품 설명</h4>
					 <p th:utext="${product.productDescription}"></p>
				</div>

				<!-- 리뷰 -->
				<div class="tab-pane fade" id="review" role="tabpanel" aria-labelledby="review-tab">
					<div class="row">
						<div class="col-lg-6">
							<div class="row total_rate">
								<div class="col-6">
									<div class="box_total">
										<h5>종합</h5>
										<h4>4.5</h4>
										<h6>(15,300 리뷰)</h6>
									</div>
									<!-- Thymeleaf로 변경 시 (리뷰 데이터는 별도 DTO로 가정): -->
									<!-- <div class="box_total"> -->
									<!--     <h5>종합</h5> -->
									<!--     <h4 th:text="${reviewSummary.averageRating}"></h4> -->
									<!--     <h6 th:text="'(' + ${#numbers.formatInteger(reviewSummary.totalReviews, 0, 'COMMA')} + ' 리뷰)'"></h6> -->
									<!-- </div> -->
								</div>
								<div class="col-6">
									<div class="rating_list">
										<h3>15,300 리뷰 기준</h3>
										<ul class="list">
											<li><a href="#">5점 <i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i> 10,000</a></li>
											<li><a href="#">4점 <i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i> 4,000</a></li>
											<li><a href="#">3점 <i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i> 1,000</a></li>
											<li><a href="#">2점 <i class="fa fa-star"></i><i class="fa fa-star"></i> 200</a></li>
											<li><a href="#">1점 <i class="fa fa-star"></i> 100</a></li>
										</ul>
									</div>
									<!-- Thymeleaf로 변경 시: -->
									<!-- <div class="rating_list"> -->
									<!--     <h3 th:text="${#numbers.formatInteger(reviewSummary.totalReviews, 0, 'COMMA')} + ' 리뷰 기준'"></h3> -->
									<!--     <ul class="list"> -->
									<!--         <li><a href="#">5점 <i th:each="i : ${#numbers.sequence(1, 5)}" class="fa fa-star"></i> <span th:text="${#numbers.formatInteger(reviewSummary.ratingDistribution[5], 0, 'COMMA')}"></span></a></li> -->
									<!--         <li><a href="#">4점 <i th:each="i : ${#numbers.sequence(1, 4)}" class="fa fa-star"></i> <span th:text="${#numbers.formatInteger(reviewSummary.ratingDistribution[4], 0, 'COMMA')}"></span></a></li> -->
									<!--         <li><a href="#">3점 <i th:each="i : ${#numbers.sequence(1, 3)}" class="fa fa-star"></i> <span th:text="${#numbers.formatInteger(reviewSummary.ratingDistribution[3], 0, 'COMMA')}"></span></a></li> -->
									<!--         <li><a href="#">2점 <i th:each="i : ${#numbers.sequence(1, 2)}" class="fa fa-star"></i> <span th:text="${#numbers.formatInteger(reviewSummary.ratingDistribution[2], 0, 'COMMA')}"></span></a></li> -->
									<!--         <li><a href="#">1점 <i th:each="i : ${#numbers.sequence(1, 1)}" class="fa fa-star"></i> <span th:text="${#numbers.formatInteger(reviewSummary.ratingDistribution[1], 0, 'COMMA')}"></span></a></li> -->
									<!--     </ul> -->
									<!-- </div> -->
								</div>
							</div>
							<div class="review_list">
								<!-- 정적 플레이스홀더 -->
								<div class="review_item">
									<div class="media">
										<div class="d-flex">
											<img src="/img/product/user.png" alt="사용자">
										</div>
										<div class="media-body">
											<h4>이수진</h4>
											<i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i>
										</div>
									</div>
									<p>역사와 과학을 융합한 접근 방식이 매우 흥미로웠습니다. 모든 역사 애호가에게 추천합니다!</p>
								</div>
								<!-- Thymeleaf로 변경 시: -->
								<!-- <div class="review_item" th:each="review : ${reviews}"> -->
								<!--     <div class="media"> -->
								<!--         <div class="d-flex"> -->
								<!--             <img th:src="${review.userImagePath}" th:alt="'사용자'" /> -->
								<!--         </div> -->
								<!--         <div class="media-body"> -->
								<!--             <h4 th:text="${review.userName}"></h4> -->
								<!--             <i th:each="i : ${#numbers.sequence(1, review.rating)}" class="fa fa-star"></i> -->
								<!--         </div> -->
								<!--     </div> -->
								<!--     <p th:text="${review.content}"></p> -->
								<!-- </div> -->
							</div>
						</div>
						<div class="col-lg-6">
							<div class="review_box">
								<h4>리뷰 작성</h4>
								<p>평점:</p>
								<ul class="list">
									<li><a href="#"><i class="fa fa-star"></i></a></li>
									<li><a href="#"><i class="fa fa-star"></i></a></li>
									<li><a href="#"><i class="fa fa-star"></i></a></li>
									<li><a href="#"><i class="fa fa-star"></i></a></li>
									<li><a href="#"><i class="fa fa-star"></i></a></li>
								</ul>
								<p>훌륭함</p>
								<form class="contact_form" method="post">
									<div class="form-group">
										<input type="text" class="form-control" name="name" placeholder="성명" required>
									</div>
									<div class="form-group">
										<input type="email" class="form-control" name="email" placeholder="이메일 주소" required>
									</div>
									<div class="form-group">
										<input type="text" class="form-control" name="phone" placeholder="전화번호">
									</div>
									<div class="form-group">
										<textarea class="form-control" name="review" rows="5" placeholder="리뷰" required></textarea>
									</div>
									<div class="form-group">
										<button type="submit" class="primary-btn">제출</button>
									</div>
								</form>
								<!-- Thymeleaf로 변경 시: -->
								<!-- <form class="contact_form" th:action="@{/reviews/add(productId=${product.productId})}" method="post"> -->
								<!--     <div class="form-group"> -->
								<!--         <input type="text" class="form-control" name="name" placeholder="성명" required> -->
								<!--     </div> -->
								<!--     <div class="form-group"> -->
								<!--         <input type="email" class="form-control" name="email" placeholder="이메일 주소" required> -->
								<!--     </div> -->
								<!--     <div class="form-group"> -->
								<!--         <input type="text" class="form-control" name="phone" placeholder="전화번호"> -->
								<!--     </div> -->
								<!--     <div class="form-group"> -->
								<!--         <textarea class="form-control" name="review" rows="5" placeholder="리뷰" required></textarea> -->
								<!--     </div> -->
								<!--     <div class="form-group"> -->
								<!--         <button type="submit" class="primary-btn">제출</button> -->
								<!--     </div> -->
								<!-- </form> -->
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>

	<!--주문 하기 시 DTO 전송-->
	<script>
		function submitOrder() {

			const form = document.createElement('form');
			form.method = 'POST';
			form.action = '/order';

			const productIds = document.createElement('input');
			productIds.type = 'hidden';
			productIds.name = 'productIds';
			productIds.value = [[${product.productId}]];

			const quantities = document.createElement('input');
			quantities.type = 'hidden';
			quantities.name = 'cartQuantities';
			quantities.value = document.getElementById('quantity').value;

			form.appendChild(productIds);
			form.appendChild(quantities);

			document.body.appendChild(form);
			form.submit();
		}
	</script>

	<!-- 사진 넘기기 -->
	<script>
		let currentSlide = 0;
		const slides = document.querySelectorAll('.slide');

		function showSlide(index) {
			// 경계 처리: 슬라이드 인덱스가 범위를 벗어나면 순환
			if (index >= slides.length) {
				currentSlide = 0;
			} else if (index < 0) {
				currentSlide = slides.length - 1;
			} else {
				currentSlide = index;
			}

			// 모든 슬라이드를 숨기고 현재 슬라이드만 표시
			slides.forEach((slide, i) => {
				slide.style.display = i === currentSlide ? 'block' : 'none';
			});
		}

		function changeSlide(direction) {
			showSlide(currentSlide + direction);
		}

		// 초기화: 첫 번째 슬라이드만 표시
		if (slides.length > 0) {
			showSlide(currentSlide);
		}
	</script>

	<!-- 수량 조절 -->
	<script>
		function adjustQuantity(change) {
			const input = document.getElementById('quantity');
			const maxStock = parseInt(input.max, 10);
			let currentValue = parseInt(input.value, 10);

			if (isNaN(currentValue)) {
				currentValue = 0;
			}

			const newValue = currentValue + change;

			if (newValue >= 0 && newValue <= maxStock) {
				input.value = newValue;
			} else if (newValue < 0) {
				input.value = 0;
				alert('수량은 0 이하로 설정할 수 없습니다.');
			} else if (newValue > maxStock) {
				input.value = maxStock;
				alert('재고 수량(' + maxStock + '개)을 초과할 수 없습니다.');
			}
		}

		function validateQuantity() {
			const input = document.getElementById('quantity');
			const maxStock = parseInt(input.max, 10);
			let value = parseInt(input.value, 10);

			if (isNaN(value) || value < 0) {
				input.value = 0;
				return;
			}

			if (value > maxStock) {
				alert('수량이 충분하지 않습니다');
				input.value = maxStock;
			}
		}
	</script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script th:src="@{/js/cart/member/member-cart-add.js}"></script>
</div>
</body>
</html>


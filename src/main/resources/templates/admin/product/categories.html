<!--Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ - Ïπ¥ÌÖåÍ≥†Î¶¨-->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin-layout}">
<body>
<div layout:fragment="content">
    <style>
        .category-dash ul {
            list-style-type: none;
            padding-left: 0;
        }

        .category-dash ul li {
            border-left: 1px dashed #ccc;
            padding-left: 10px;
        }

        .category-left {
            display: flex;
            flex-direction: column;
        }

        .toggle {
            cursor: pointer;
            margin-right: 5px;
        }
    </style>

    <section>
        <div class="container">
            <h2>Category Management</h2>

            <!-- Îì±Î°ù Ìèº -->
            <div class="row">
                <div class="col-lg-8">
                    <h4>Register New Category</h4>
                    <form class="row login_form" action="/admin/settings/categories" method="post">
                        <div class="col-md-6 form-group">
                            <input type="text" class="form-control" name="categories[0].categoryName" placeholder="ÏµúÏÉÅÏúÑ Ïπ¥ÌÖåÍ≥†Î¶¨Î™Ö" required>
                        </div>
                        <div class="col-md-6 form-group">
                            <input type="text" class="form-control" name="categories[1].categoryName" placeholder="ÌïòÏúÑ Ïπ¥ÌÖåÍ≥†Î¶¨Î™Ö" required>
                        </div>
                        <div class="col-12 form-group mt-3">
                            <button type="submit" class="button button-register w-100">Register Category</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Ï°∞Ìöå ÏòÅÏó≠ -->
            <div class="row mb-5">
                <div class="col-12 category-dash">
                    <h4>Category List</h4>
                    <ul id="categoryTree">
                        <li th:each="category : ${categories}" class="mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <!-- Îì§Ïó¨Ïì∞Í∏∞ + ÌÖçÏä§Ìä∏ -->
                                <div class="category-left">
                                    <div class="d-flex align-items-center">
                                        <span class="toggle me-2" onclick="toggleClick(this)">üìÅ</span>
                                        <span th:text="${category.categoryName}"></span>
                                    </div>

                                    <!-- ÏûÖÎ†•Ï∞Ω -->
                                    <div class="category-input mt-2" style="display: none;">
                                        <input type="text" class="form-control form-control-sm d-inline-block w-auto me-2" placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨Î™Ö ÏûÖÎ†•">
                                        <button class="btn btn-sm btn-primary" onclick="submitCategory(this)">Ï†ÄÏû•</button>
                                        <button class="btn btn-sm btn-secondary" onclick="cancelInput(this)">Ï∑®ÏÜå</button>
                                    </div>
                                </div>

                                <!-- Ïò§Î•∏Ï™Ω Î≤ÑÌäº -->
                                <div class="ms-2">
                                    <button class="btn btn-sm btn-outline-success"
                                            th:onclick="'showInput(this, \'POST\', ' + ${category.categoryId} + ')'">Ï∂îÍ∞Ä</button>
                                    <button class="btn btn-sm btn-outline-primary"
                                            th:onclick="'showInput(this, \'PUT\', ' + ${category.categoryId} + ')'">ÏàòÏ†ï</button>
                                </div>
                            </div>

                            <!-- ÏûêÏãù Ïπ¥ÌÖåÍ≥†Î¶¨ -->
                            <ul th:if="${#lists.size(category.children) > 0}" class="ms-4 mt-2">
                                <th:block th:replace="admin/product/categoryFragment :: categoryFragment(category=${category})" />
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>

        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const toggles = document.querySelectorAll("#categoryTree .toggle");

                toggles.forEach(span => {
                    const li = span.closest("li");
                    const childUl = li.querySelector("ul");

                    if (!childUl) {
                        span.textContent = "üîπ"; // ÏûêÏãùÏù¥ ÏóÜÎäî Í≤ΩÏö∞
                    } else {
                        span.textContent = "üìÅ"; // ÏûêÏãù ÏûàÎäî Í≤ΩÏö∞ Í∏∞Î≥∏ÏùÄ Îã´Ìûå Ìè¥Îçî
                        childUl.style.display = "none"; // Í∏∞Î≥∏ÏùÄ Îã´Ìûå ÏÉÅÌÉú
                    }
                });
            });

            function toggleClick(element) {
                const parentLi = element.closest("li");
                const childUl = parentLi.querySelector("ul");

                if (childUl) {
                    const isVisible = childUl.style.display !== "none";
                    childUl.style.display = isVisible ? "none" : "block";
                    element.textContent = isVisible ? "üìÅ" : "üìÇ"; // Îã´ÌûòÏù¥Î©¥ üìÅ, Ïó¥Î¶ºÏù¥Î©¥ üìÇ
                }
            }

            function showInput(button, method, categoryId) {
                const li = button.closest("li");
                const inputDiv = li.querySelector(".category-input");
                inputDiv.style.display = "block";
                inputDiv.dataset.method = method;
                inputDiv.dataset.categoryId = categoryId;
            }

            function cancelInput(button) {
                const inputDiv = button.closest(".category-input");
                inputDiv.style.display = "none";
                inputDiv.querySelector("input").value = "";
            }

            function submitCategory(button) {
                const inputDiv = button.closest(".category-input");
                const method = inputDiv.dataset.method;
                const categoryId = inputDiv.dataset.categoryId;
                const name = inputDiv.querySelector("input").value.trim();

                console.log(method);
                console.log(categoryId);
                console.log(name);

                if (!name) {
                    alert("Ïπ¥ÌÖåÍ≥†Î¶¨Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                    return;
                }

                fetch("/admin/settings/categories/" + categoryId, {
                    method: method,
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({categoryName: name})
                }).then(res => {
                    if (res.ok) {
                        window.location.reload();
                    } else {
                        alert("Ïò§Î•ò Î∞úÏÉù");
                    }
                });
            }

            function deleteCategory(button, categoryId) {
                if (!confirm("Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;

                fetch("/admin/settings/categories/" + categoryId, {
                    method: "DELETE"
                }).then(res => {
                    if (res.ok) {
                        window.location.reload();
                    } else {
                        alert("ÏÇ≠Ï†ú Ïã§Ìå®");
                    }
                });
            }

            // function updateCategoryName(categoryId) {
            //     const selectedValue = document.querySelector(`#saleable-${categoryId} > div > span`).innerHTML;
            //     const wrapperSaleable = selectedValue === "ÌåêÎß§ Ï§ë";
            //
            //     console.log("Selected saleable value:", selectedValue);
            //     console.log("Converted boolean:", wrapperSaleable);
            //
            //     fetch("/admin/settings/categoryId/" + categoryId, {
            //         method: "PUT",
            //         headers: {
            //             "Content-Type": "application/json",
            //         },
            //         body: JSON.stringify({wrapperSaleable: wrapperSaleable})
            //     }).then(res => {
            //         if (!res.ok) {
            //             alert("ÏàòÏ†ï Ïã§Ìå®");
            //         }
            //     });
            // }
        </script>
    </section>
</div>
</body>
</html>
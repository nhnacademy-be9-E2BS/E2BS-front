<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin-layout}">
<body>
<div layout:fragment="content">
    <section>
        <div class="container">
            <h2>ì¿ í° ë“±ë¡</h2>

            <!-- ìŠ¤íƒ€ì¼ -->
            <style>
                .table th {
                    text-align: center;
                    vertical-align: middle;
                    color: #333;
                    font-size: 15px;
                }

                .table thead th {
                    font-weight: 600;
                    background: #fafafa;
                    border-top: 2px solid #666;
                }

                .coupon-section {
                    border: 1px solid #eee;
                    padding: 20px;
                    border-radius: 6px;
                    background-color: #fff;
                    margin-bottom: 40px;
                }

                .pagination .page-link {
                    color: #333;
                }

                .pagination .page-item.active .page-link {
                    background-color: #666;
                    border-color: #666;
                    color: #fff;
                }

                /* ë§í¬ ìŠ¤íƒ€ì¼ ì œê±° */
                a.coupon-link {
                    color: #333 !important;
                    text-decoration: none;
                }

                a.coupon-link:hover {
                    text-decoration: underline;
                }

                /* ì¹´í…Œê³ ë¦¬ íŠ¸ë¦¬ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) */
                .category-dash ul {
                    list-style-type: none;
                    padding-left: 0;
                }

                .category-dash ul li {
                    border-left: 1px dashed #ccc;
                    padding-left: 10px;
                }

                .category-left {
                    display: flex;
                    flex-direction: column;
                }

                .toggle {
                    cursor: pointer;
                    margin-right: 5px;
                }

                /* ìˆ¨ê¹€ ì²˜ë¦¬ */
                .hidden {
                    display: none;
                }

                /* select multiple ë†’ì´ */
                select[multiple] {
                    height: 300px;
                }

                table th {
                    white-space: nowrap;
                    vertical-align: top;
                    text-align: left;
                }
                /* ëª¨ë‹¬ ì „ì²´ ë°°ê²½ (ì–´ë‘¡ê³  ë°˜íˆ¬ëª…) */
                .modal {
                    display: none; /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
                    position: fixed;
                    z-index: 1000; /* ìµœìƒìœ„ */
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto; /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
                    background-color: rgba(0, 0, 0, 0.5); /* ë°˜íˆ¬ëª… ê²€ì • */
                }

                /* ëª¨ë‹¬ ë‚´ìš© ë°•ìŠ¤ */
                .modal-content {
                    background-color: #fff;
                    margin: 10% auto; /* í™”ë©´ ìƒë‹¨ì—ì„œ 10% ì•„ë˜, ê°€ë¡œ ì¤‘ì•™ */
                    padding: 20px 30px;
                    border-radius: 8px;
                    width: 600px;
                    max-width: 90%;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                    position: relative;
                }

                /* ë‹«ê¸° ë²„íŠ¼ */
                .close {
                    color: #aaa;
                    position: absolute;
                    top: 15px;
                    right: 20px;
                    font-size: 28px;
                    font-weight: bold;
                    cursor: pointer;
                    transition: color 0.3s ease;
                }

                .close:hover,
                .close:focus {
                    color: #000;
                    text-decoration: none;
                }

                /* ì œëª© ìŠ¤íƒ€ì¼ */
                .modal-content h2 {
                    margin-top: 0;
                    font-weight: 700;
                    color: #333;
                }
            </style>

            <div class="coupon-section">
                <h4 style="font-size: 18px; font-weight: bold; margin-bottom: 16px;">ìƒˆ ì¿ í° ë“±ë¡
                    <span style="font-size: 14px; color: #888; font-weight: normal;">| ì¿ í° ì •ì±…ê³¼ ì¢…ë¥˜ë¥¼ ì„ íƒí•˜ì—¬ ì¿ í°ì„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                </h4>

                <div class="alert alert-warning" role="alert" style="font-size: 14px;">
                    â€» ì¼ë°˜ì¿ í°, ìƒì¼ì¿ í°, ì›°ì»´ì¿ í°ì€ ì „ì²´ ë„ì„œì— ëŒ€í•´ í• ì¸ì´ ì ìš©ë©ë‹ˆë‹¤.<br>
                    â€» ìƒì¼ì¿ í°ì˜ ì¿ í°ëª…ì€ "Xì›” ìƒì¼ ì¿ í°" ìœ¼ë¡œ ëª…í™•íˆ ì‘ì„±í•´ì£¼ì„¸ìš”.<br>
                    â€» ì›°ì»´ì¿ í°ì˜ ì¿ í°ëª…ì€ "ì›°ì»´ ì¿ í°" ìœ¼ë¡œ ëª…í™•íˆ ì‘ì„±í•´ì£¼ì„¸ìš”.<br>
                </div>

                <form action="/admin/settings/coupons/register" method="post" class="row g-3">

                    <table class="table table-bordered">
                        <tbody>
                        <tr>
                            <th>ì¿ í° ì¢…ë¥˜</th>
                            <td>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="couponType" id="typeTotal" value="total" th:checked="${couponType == 'total'}">
                                    <label class="form-check-label" for="typeTotal">ì „ì²´ í• ì¸ (ì¼ë°˜, ìƒì¼, Welcome)</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="couponType" id="typeCategory" value="category">
                                    <label class="form-check-label" for="typeCategory">ì¹´í…Œê³ ë¦¬ í• ì¸</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="couponType" id="typeProduct" value="product" th:checked="${couponType == 'product'}">
                                    <label class="form-check-label" for="typeProduct">ë„ì„œ í• ì¸</label>
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <th style="width: 100px;">ì¿ í°ëª…</th>
                            <td>
                                <input type="text" class="form-control" name="couponName" placeholder="ì¿ í°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                            </td>
                        </tr>

                        <tr>
                            <th>ì¿ í° ì •ì±…</th>
                            <td>
                                <select class="form-select" name="couponPolicyId" required>
                                    <option value="none" disabled selected>ì„ íƒí•´ì£¼ì„¸ìš”</option>
                                    <option th:each="policy : ${couponPolicies}"
                                            th:value="${policy.couponPolicyId}"
                                            th:text="${policy.couponPolicyName + ' (' + #temporals.format(policy.couponPolicyCreatedAt, 'yyyy-MM-dd') + ')'}">
                                    </option>
                                </select>
                            </td>
                        </tr>



                        <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ (ì›ë³¸ ìœ ì§€) -->
                        <tr id="categoryRow" class="hidden">
                            <th>ì¹´í…Œê³ ë¦¬</th>
                            <td>
                                <div class="row mb-5">
                                    <div class="col-12 category-dash">
                                        <ul id="categoryTree">
                                            <li th:each="category : ${categories}" class="mb-2">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="category-left">
                                                        <div class="d-flex align-items-center">
                                                            <span class="toggle me-2" onclick="toggleClick(this)">ğŸ“</span>
                                                            <span th:text="${category.categoryName}"></span>
                                                        </div>
                                                    </div>
                                                    <div class="ms-2">
                                                        <button type="button" class="btn btn-sm btn-outline-success"
                                                                th:attr="data-id=${category.categoryId}, data-name=${category.categoryName}"
                                                                onclick="selectCategory(this)">ì„ íƒ</button>
                                                    </div>
                                                </div>
                                                <ul th:if="${category.children != null and #lists.size(category.children) > 0}" class="ms-4 mt-2">
                                                    <th:block th:replace="admin/coupon/coupon-register-category-fragment :: category-fragment(category=${category})" />
                                                </ul>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <tr id="categoryRow2" class="hidden">
                            <th>ì„ íƒí•œ ì¹´í…Œê³ ë¦¬</th>
                            <td>
                                <span id="selectedCategoryName">ì—†ìŒ</span>
                                <input type="hidden" name="categoryId" id="selectedCategoryId" />
                            </td>
                        </tr>

                        <tr id="productRowSearch" class="hidden">
                            <th>ë„ì„œ ê²€ìƒ‰</th>
                            <td>
                                <button type="button" class="btn btn-outline-primary" id="openModalBtn">
                                    ê²€ìƒ‰í•˜ê¸°
                                </button>

                                <a href="/admin/settings/coupons/register?couponType=product" class="btn btn-outline-secondary" style="margin-left: 8px;">
                                    ì „ì²´ì¡°íšŒ
                                </a>
                            </td>
                        </tr>

                        <tr id="productRow" class="hidden">
                            <th>ë„ì„œ</th>
                            <td>
                                <div class="row mb-5">
                                    <div class="col-12">
                                        <table class="table table-bordered">
                                            <thead>
                                            <tr>
                                                <th>ì´ë¯¸ì§€</th>
                                                <th>ISBN</th>
                                                <th>ë„ì„œëª…</th>
                                                <th>ê¸°ì—¬ì</th>
                                                <th>ì¶œíŒì‚¬</th>
                                                <th>ì •ê°€</th>
                                                <th>ì¬ê³ </th>
                                                <th>ì„ íƒ</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr th:each="product : ${products}">
                                                <td th:if="${product.productImagePaths != null and !#lists.isEmpty(product.productImagePaths)}">
                                                    <img th:src="${product.productImagePaths[0].productImagePath}"
                                                         th:alt="${product.productTitle} + ' í‘œì§€ ì´ë¯¸ì§€'"
                                                         style="width: 50px; height: auto;"
                                                         onerror="this.src='https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRIU-UceDHDzvuE5Gp1xYX0irHtgIWTeWwzlPVvLegZoes3vFaKT736CE8&s'">
                                                </td>

                                                <td th:text="${product.productIsbn}">-</td>
                                                <td th:text="${product.productTitle}"
                                                    th:title="${product.productTitle}"
                                                    style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    -
                                                </td>
                                                <td>
                                                    <ul>
                                                        <li th:each="contributor : ${product.contributors}" th:text="${contributor.contributorName}"></li>
                                                    </ul>
                                                </td>
                                                <td th:text="${product.publisher != null ? product.publisher.publisherName : 'ì¶œíŒì‚¬ ì •ë³´ ì—†ìŒ'}">-</td>
                                                <td th:text="${T(java.lang.String).format('%,dì›', product.productRegularPrice)}">1,000ì›</td>
                                                <td th:text="${product.productStock + 'ê°œ'}">30ê°œ</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-outline-success"
                                                            th:attr="data-id=${product.productId}, data-name=${product.productTitle}"
                                                            onclick="selectProduct(this)">
                                                        ì„ íƒ
                                                    </button>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>

                                        <!-- í˜ì´ì§• -->
                                        <div class="row">
                                            <div class="col-12 d-flex justify-content-center">
                                                <nav>
                                                    <ul class="pagination" th:if="${products.totalPages > 0}">
                                                        <li class="page-item" th:classappend="${!products.hasPrevious()} ? 'disabled'">
                                                            <a class="page-link" th:href="@{'/admin/settings/coupons/register'(page=0, size=${products.size}, couponType='product')}">ì²˜ìŒ</a>
                                                        </li>

                                                        <li class="page-item"
                                                            th:each="i : ${#numbers.sequence(0, products.totalPages - 1)}"
                                                            th:classappend="${i == products.number} ? 'active'">
                                                            <a class="page-link"
                                                               th:href="@{'/admin/settings/coupons/register'(page=${i}, size=${products.size}, couponType='product')}"
                                                               th:text="${i + 1}">1</a>
                                                        </li>

                                                        <li class="page-item" th:classappend="${!products.hasNext()} ? 'disabled'">
                                                            <a class="page-link"
                                                               th:href="@{'/admin/settings/coupons/register'(page=${products.totalPages - 1}, size=${products.size}, couponType='product')}">ë§ˆì§€ë§‰</a>
                                                        </li>
                                                    </ul>
                                                </nav>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <tr id="productRow2" class="hidden">
                            <th>ì„ íƒí•œ ë„ì„œ</th>
                            <td>
                                <span id="selectedProductName">ì—†ìŒ</span>
                                <input type="hidden" name="productId" id="selectedProductId" />
                            </td>
                        </tr>

                        </tbody>
                    </table>

                    <div class="col-12 text-center">
                        <button type="submit" class="btn btn-sm" style="background-color: #666; color: #fff; font-weight: 600; width: 120px;">
                            ì¿ í° ë“±ë¡
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ëª¨ë‹¬ -->
        <div id="productSearchModal" class="modal">
            <div class="modal-content">
                <span id="closeModalBtn" class="close">&times;</span>
                <h2>ë„ì„œ ê²€ìƒ‰</h2>

                <!-- ê²€ìƒ‰ í¼ -->
                <form id="searchForm" method="get" action="/admin/settings/coupons/register">
                    <input type="text" name="keyword" required placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
                    <input type="hidden" name="couponType" value="product" />
                    <button type="submit">ê²€ìƒ‰</button>
                </form>

            </div>
        </div>


        <!-- ìŠ¤í¬ë¦½íŠ¸ -->
        <script>
            // ëª¨ë‹¬ ì—´ê³  ë‹«ê¸°
            const modal = document.getElementById('productSearchModal');
            const openBtn = document.getElementById('openModalBtn');
            const closeBtn = document.getElementById('closeModalBtn');
            openBtn.addEventListener('click', () => {
                modal.style.display = 'block';
            });
            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });



            // ì¹´í…Œê³ ë¦¬ íŠ¸ë¦¬ í† ê¸€ (ì›ë³¸ ìœ ì§€)
            function toggleClick(elem) {
                const ul = elem.closest('li').querySelector('ul');
                if (ul) {
                    ul.style.display = ul.style.display === 'none' ? 'block' : 'none';
                }
            }

            // ì¿ í° ì¢…ë¥˜ì— ë”°ë¼ ì˜ì—­ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
            const couponTypeRadios = document.querySelectorAll('input[name="couponType"]');
            const categoryRow = document.getElementById('categoryRow');
            const categoryRow2 = document.getElementById('categoryRow2');
            const productRowSearch = document.getElementById('productRowSearch');
            const productRow = document.getElementById('productRow');
            const productRow2 = document.getElementById('productRow2');

            function updateCouponTypeView() {
                const selected = document.querySelector('input[name="couponType"]:checked').value;
                if (selected === 'total') {
                    categoryRow.classList.add('hidden');
                    categoryRow2.classList.add('hidden');
                    productRowSearch.classList.add('hidden');
                    productRow.classList.add('hidden');
                    productRow2.classList.add('hidden');
                } else if (selected === 'category') {
                    categoryRow.classList.remove('hidden');
                    categoryRow2.classList.remove('hidden');
                    productRowSearch.classList.add('hidden');
                    productRow.classList.add('hidden');
                    productRow2.classList.add('hidden');
                } else if (selected === 'product') {
                    categoryRow.classList.add('hidden');
                    categoryRow2.classList.add('hidden');
                    productRowSearch.classList.remove('hidden');
                    productRow.classList.remove('hidden');
                    productRow2.classList.remove('hidden');
                }
            }

            couponTypeRadios.forEach(radio => {
                radio.addEventListener('change', updateCouponTypeView);
            });

            updateCouponTypeView();

            // ì¹´í…Œê³ ë¦¬ ì„ íƒ
            function selectCategory(button) {
                const id = button.getAttribute('data-id');
                const name = button.getAttribute('data-name');

                document.getElementById('selectedCategoryId').value = id;
                document.getElementById('selectedCategoryName').innerText = name;
            }

            // ë„ì„œ ì„ íƒ
            function selectProduct(button) {
                const id = button.getAttribute('data-id');
                const name = button.getAttribute('data-name');

                document.getElementById('selectedProductId').value = id;
                document.getElementById('selectedProductName').innerText = name;
            }

            // í¼ ì œì¶œ ì‹œ ê²€ì¦
            document.querySelector('form').addEventListener('submit', function(event) {
                const couponType = document.querySelector('input[name="couponType"]:checked').value;
                if (couponType === 'category') {
                    if (!document.getElementById('selectedCategoryId').value) {
                        alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                        event.preventDefault();
                        return false;
                    }
                } else if (couponType === 'product') {
                    if (!document.getElementById('selectedProductId').value) {
                        alert('ë„ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                        event.preventDefault();
                        return false;
                    }
                }
            });

            document.addEventListener("DOMContentLoaded", () => {
                const toggles = document.querySelectorAll("#categoryTree .toggle");

                toggles.forEach(span => {
                    const li = span.closest("li");
                    const childUl = li.querySelector("ul");

                    if (!childUl) {
                        span.textContent = "ğŸ”¹";
                    } else {
                        span.textContent = "ğŸ“‚";
                    }
                });
            });
        </script>
    </section>
</div>
</body>
</html>

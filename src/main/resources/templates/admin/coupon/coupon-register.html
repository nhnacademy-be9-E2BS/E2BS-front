<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin-layout}">
<body>
<div layout:fragment="content">
    <section>
        <div class="container">
            <h2>Ïø†Ìè∞ Îì±Î°ù</h2>

            <!-- Ïä§ÌÉÄÏùº -->
            <style>
                .table th {
                    text-align: center;
                    vertical-align: middle;
                    color: #333;
                    font-size: 15px;
                }

                .table thead th {
                    font-weight: 600;
                    background: #fafafa;
                    border-top: 2px solid #666;
                }

                .coupon-section {
                    border: 1px solid #eee;
                    padding: 20px;
                    border-radius: 6px;
                    background-color: #fff;
                    margin-bottom: 40px;
                }

                .pagination .page-link {
                    color: #333;
                }

                .pagination .page-item.active .page-link {
                    background-color: #666;
                    border-color: #666;
                    color: #fff;
                }

                /* ÎßÅÌÅ¨ Ïä§ÌÉÄÏùº Ï†úÍ±∞ */
                a.coupon-link {
                    color: #333 !important;
                    text-decoration: none;
                }

                a.coupon-link:hover {
                    text-decoration: underline;
                }

                /* Ïπ¥ÌÖåÍ≥†Î¶¨ Ìä∏Î¶¨ Ïä§ÌÉÄÏùº (Í∏∞Ï°¥ Ïú†ÏßÄ) */
                .category-dash ul {
                    list-style-type: none;
                    padding-left: 0;
                }

                .category-dash ul li {
                    border-left: 1px dashed #ccc;
                    padding-left: 10px;
                }

                .category-left {
                    display: flex;
                    flex-direction: column;
                }

                .toggle {
                    cursor: pointer;
                    margin-right: 5px;
                }

                /* Ïà®ÍπÄ Ï≤òÎ¶¨ */
                .hidden {
                    display: none;
                }

                /* select multiple ÎÜíÏù¥ */
                select[multiple] {
                    height: 300px;
                }

                table th {
                    white-space: nowrap;
                    vertical-align: top;
                    text-align: left;
                }
            </style>

            <div class="coupon-section">
                <h4 style="font-size: 18px; font-weight: bold; margin-bottom: 16px;">ÏÉà Ïø†Ìè∞ Îì±Î°ù
                    <span style="font-size: 14px; color: #888; font-weight: normal;">| Ïø†Ìè∞ Ï†ïÏ±ÖÍ≥º Ï¢ÖÎ•òÎ•º ÏÑ†ÌÉùÌïòÏó¨ Ïø†Ìè∞ÏùÑ Îì±Î°ùÌï† Ïàò ÏûàÏäµÎãàÎã§.</span>
                </h4>

                <div class="alert alert-warning" role="alert" style="font-size: 14px;">
                    ‚Äª ÏùºÎ∞òÏø†Ìè∞, ÏÉùÏùºÏø†Ìè∞, Ïõ∞Ïª¥Ïø†Ìè∞ÏùÄ Ï†ÑÏ≤¥ ÎèÑÏÑúÏóê ÎåÄÌï¥ Ìï†Ïù∏Ïù¥ Ï†ÅÏö©Îê©ÎãàÎã§.<br>
                    ‚Äª ÏÉùÏùºÏø†Ìè∞Ïùò Ïø†Ìè∞Î™ÖÏùÄ "XÏõî ÏÉùÏùº Ïø†Ìè∞" ÏúºÎ°ú Î™ÖÌôïÌûà ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.<br>
                    ‚Äª Ïõ∞Ïª¥Ïø†Ìè∞Ïùò Ïø†Ìè∞Î™ÖÏùÄ "Ïõ∞Ïª¥ Ïø†Ìè∞" ÏúºÎ°ú Î™ÖÌôïÌûà ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.<br>
                </div>

                <form action="/admin/settings/coupons/register" method="post" class="row g-3">

                    <table class="table table-bordered">
                        <tbody>
                        <tr>
                            <th style="width: 180px;">Ïø†Ìè∞Î™Ö</th>
                            <td>
                                <input type="text" class="form-control" name="couponName" placeholder="Ïø†Ìè∞Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" required>
                            </td>
                        </tr>

                        <tr>
                            <th>Ïø†Ìè∞ Ï†ïÏ±Ö</th>
                            <td>
                                <select class="form-select" name="couponPolicyId" required>
                                    <option value="none" disabled selected>ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</option>
                                    <option th:each="policy : ${couponPolicies}"
                                            th:value="${policy.couponPolicyId}"
                                            th:text="${policy.couponPolicyName + ' (' + #temporals.format(policy.couponPolicyCreatedAt, 'yyyy-MM-dd') + ')'}">
                                    </option>
                                </select>
                            </td>
                        </tr>

                        <tr>
                            <th>Ïø†Ìè∞ Ï¢ÖÎ•ò</th>
                            <td>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="couponType" id="typeTotal" value="total" th:checked="${couponType == 'total'}">
                                    <label class="form-check-label" for="typeTotal">Ï†ÑÏ≤¥ Ìï†Ïù∏ (ÏùºÎ∞ò, ÏÉùÏùº, Welcome)</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="couponType" id="typeCategory" value="category">
                                    <label class="form-check-label" for="typeCategory">Ïπ¥ÌÖåÍ≥†Î¶¨ Ìï†Ïù∏</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="couponType" id="typeProduct" value="product" th:checked="${couponType == 'product'}">
                                    <label class="form-check-label" for="typeProduct">ÎèÑÏÑú Ìï†Ïù∏</label>
                                </div>
                            </td>
                        </tr>

                        <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù (ÏõêÎ≥∏ Ïú†ÏßÄ) -->
                        <tr id="categoryRow" class="hidden">
                            <th>Ïπ¥ÌÖåÍ≥†Î¶¨</th>
                            <td>
                                <div class="row mb-5">
                                    <div class="col-12 category-dash">
                                        <ul id="categoryTree">
                                            <li th:each="category : ${categories}" class="mb-2">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="category-left">
                                                        <div class="d-flex align-items-center">
                                                            <span class="toggle me-2" onclick="toggleClick(this)">üìÅ</span>
                                                            <span th:text="${category.categoryName}"></span>
                                                        </div>
                                                    </div>
                                                    <div class="ms-2">
                                                        <button type="button" class="btn btn-sm btn-outline-success"
                                                                th:attr="data-id=${category.categoryId}, data-name=${category.categoryName}"
                                                                onclick="selectCategory(this)">ÏÑ†ÌÉù</button>
                                                    </div>
                                                </div>
                                                <ul th:if="${#lists.size(category.children) > 0}" class="ms-4 mt-2">
                                                    <th:block th:replace="admin/coupon/coupon-register-categoryFragment :: categoryFragment(category=${category})" />
                                                </ul>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <tr id="categoryRow2" class="hidden">
                            <th>ÏÑ†ÌÉùÌïú Ïπ¥ÌÖåÍ≥†Î¶¨</th>
                            <td>
                                <span id="selectedCategoryName">ÏóÜÏùå</span>
                                <input type="hidden" name="categoryId" id="selectedCategoryId" />
                            </td>
                        </tr>

                        <tr id="productRow" class="hidden">
                            <th>ÎèÑÏÑú</th>
                            <td>
                                <div class="row mb-5">
                                    <div class="col-12">
                                        <table class="table table-bordered">
                                            <thead>
                                            <tr>
                                                <th>Ïù¥ÎØ∏ÏßÄ</th>
                                                <th>ISBN</th>
                                                <th>ÎèÑÏÑúÎ™Ö</th>
                                                <th>Í∏∞Ïó¨Ïûê</th>
                                                <th>Ï∂úÌåêÏÇ¨</th>
                                                <th>Ï†ïÍ∞Ä</th>
                                                <th>Ïû¨Í≥†</th>
                                                <th>ÏÑ†ÌÉù</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr th:each="product : ${products}">
                                                <td th:if="${product.productImagePaths != null and !#lists.isEmpty(product.productImagePaths)}">
                                                    <img th:src="${product.productImagePaths[0].productImagePath}"
                                                         th:alt="${product.productTitle} + ' ÌëúÏßÄ Ïù¥ÎØ∏ÏßÄ'"
                                                         style="width: 50px; height: auto;"
                                                         onerror="this.src='https://via.placeholder.com/110x150?text=No+Image'">
                                                </td>
                                                <td th:text="${product.productIsbn}">-</td>
                                                <td th:text="${product.productTitle}">-</td>
                                                <td>
                                                    <ul>
                                                        <li th:each="contributor : ${product.contributors}" th:text="${contributor.contributorName}"></li>
                                                    </ul>
                                                </td>
                                                <td th:text="${product.publisher != null ? product.publisher.publisherName : 'Ï∂úÌåêÏÇ¨ Ï†ïÎ≥¥ ÏóÜÏùå'}">-</td>
                                                <td th:text="${T(java.lang.String).format('%,dÏõê', product.productRegularPrice)}">1,000Ïõê</td>
                                                <td th:text="${product.productStock + 'Í∞ú'}">30Í∞ú</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-outline-success"
                                                            th:attr="data-id=${product.productId}, data-name=${product.productTitle}"
                                                            onclick="selectProduct(this)">
                                                        ÏÑ†ÌÉù
                                                    </button>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>

                                        <!-- ÌéòÏù¥Ïßï -->
                                        <div class="row">
                                            <div class="col-12 d-flex justify-content-center">
                                                <nav>
                                                    <ul class="pagination" th:if="${products.totalPages > 0}">
                                                        <li class="page-item" th:classappend="${!products.hasPrevious()} ? 'disabled'">
                                                            <a class="page-link" th:href="@{'/admin/settings/coupons/register'(page=0, size=${products.size}, couponType='product')}">Ï≤òÏùå</a>
                                                        </li>

                                                        <li class="page-item"
                                                            th:each="i : ${#numbers.sequence(0, products.totalPages - 1)}"
                                                            th:classappend="${i == products.number} ? 'active'">
                                                            <a class="page-link"
                                                               th:href="@{'/admin/settings/coupons/register'(page=${i}, size=${products.size}, couponType='product')}"
                                                               th:text="${i + 1}">1</a>
                                                        </li>

                                                        <li class="page-item" th:classappend="${!products.hasNext()} ? 'disabled'">
                                                            <a class="page-link"
                                                               th:href="@{'/admin/settings/coupons/register'(page=${products.totalPages - 1}, size=${products.size}, couponType='product')}">ÎßàÏßÄÎßâ</a>
                                                        </li>
                                                    </ul>
                                                </nav>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <tr id="productRow2" class="hidden">
                            <th>ÏÑ†ÌÉùÌïú ÎèÑÏÑú</th>
                            <td>
                                <span id="selectedProductName">ÏóÜÏùå</span>
                                <input type="hidden" name="productId" id="selectedProductId" />
                            </td>
                        </tr>

                        </tbody>
                    </table>

                    <div class="col-12 text-center">
                        <button type="submit" class="btn btn-sm" style="background-color: #666; color: #fff; font-weight: 600; width: 120px;">
                            Ïø†Ìè∞ Îì±Î°ù
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Ïä§ÌÅ¨Î¶ΩÌä∏ -->
        <script>
            // Ïπ¥ÌÖåÍ≥†Î¶¨ Ìä∏Î¶¨ ÌÜ†Í∏Ä (ÏõêÎ≥∏ Ïú†ÏßÄ)
            function toggleClick(elem) {
                const ul = elem.closest('li').querySelector('ul');
                if (ul) {
                    ul.style.display = ul.style.display === 'none' ? 'block' : 'none';
                }
            }

            // Ïø†Ìè∞ Ï¢ÖÎ•òÏóê Îî∞Îùº ÏòÅÏó≠ Î≥¥Ïù¥Í∏∞/Ïà®Í∏∞Í∏∞
            const couponTypeRadios = document.querySelectorAll('input[name="couponType"]');
            const categoryRow = document.getElementById('categoryRow');
            const categoryRow2 = document.getElementById('categoryRow2');
            const productRow = document.getElementById('productRow');
            const productRow2 = document.getElementById('productRow2');

            function updateCouponTypeView() {
                const selected = document.querySelector('input[name="couponType"]:checked').value;
                if (selected === 'total') {
                    categoryRow.classList.add('hidden');
                    categoryRow2.classList.add('hidden');
                    productRow.classList.add('hidden');
                    productRow2.classList.add('hidden');
                } else if (selected === 'category') {
                    categoryRow.classList.remove('hidden');
                    categoryRow2.classList.remove('hidden');
                    productRow.classList.add('hidden');
                    productRow2.classList.add('hidden');
                } else if (selected === 'product') {
                    categoryRow.classList.add('hidden');
                    categoryRow2.classList.add('hidden');
                    productRow.classList.remove('hidden');
                    productRow2.classList.remove('hidden');
                }
            }

            couponTypeRadios.forEach(radio => {
                radio.addEventListener('change', updateCouponTypeView);
            });

            updateCouponTypeView();

            // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù
            function selectCategory(button) {
                const id = button.getAttribute('data-id');
                const name = button.getAttribute('data-name');

                document.getElementById('selectedCategoryId').value = id;
                document.getElementById('selectedCategoryName').innerText = name;
            }

            // ÎèÑÏÑú ÏÑ†ÌÉù
            function selectProduct(button) {
                const id = button.getAttribute('data-id');
                const name = button.getAttribute('data-name');

                document.getElementById('selectedProductId').value = id;
                document.getElementById('selectedProductName').innerText = name;
            }

            // Ìèº Ï†úÏ∂ú Ïãú Í≤ÄÏ¶ù
            document.querySelector('form').addEventListener('submit', function(event) {
                const couponType = document.querySelector('input[name="couponType"]:checked').value;
                if (couponType === 'category') {
                    if (!document.getElementById('selectedCategoryId').value) {
                        alert('Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                        event.preventDefault();
                        return false;
                    }
                } else if (couponType === 'product') {
                    if (!document.getElementById('selectedProductId').value) {
                        alert('ÎèÑÏÑúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                        event.preventDefault();
                        return false;
                    }
                }
            });

            document.addEventListener("DOMContentLoaded", () => {
                const toggles = document.querySelectorAll("#categoryTree .toggle");

                toggles.forEach(span => {
                    const li = span.closest("li");
                    const childUl = li.querySelector("ul");

                    if (!childUl) {
                        span.textContent = "üîπ";
                    } else {
                        span.textContent = "üìÇ";
                    }
                });
            });
        </script>
    </section>
</div>
</body>
</html>

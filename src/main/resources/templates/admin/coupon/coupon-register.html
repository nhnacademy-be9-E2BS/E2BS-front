<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin-layout}">
<body>
<div layout:fragment="content">
    <style>
        .category-dash ul {
            list-style-type: none;
            padding-left: 0;
        }

        .category-dash ul li {
            border-left: 1px dashed #ccc;
            padding-left: 10px;
        }

        .category-left {
            display: flex;
            flex-direction: column;
        }

        .toggle {
            cursor: pointer;
            margin-right: 5px;
        }
    </style>

    <section>
        <div class="container">
            <h2>Coupon Register</h2>

            <div class="row">
                <div class="col-lg-12">
                    <h4>Register New Coupon</h4>

                    <!-- Ïø†Ìè∞ Îì±Î°ù Ìèº -->
                    <form class="row login_form" action="/admin/settings/coupons/register" method="post">
                        <table class="table table-bordered">
                            <tbody>
                            <!-- Ïø†Ìè∞Î™Ö -->
                            <tr>
                                <th style="width: 180px;">Ïø†Ìè∞Î™Ö</th>
                                <td>
                                    <input type="text" class="form-control" name="couponName" placeholder="Ïø†Ìè∞Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" required>
                                </td>
                            </tr>

                            <!-- Ïø†Ìè∞ Ï†ïÏ±Ö -->
                            <tr>
                                <th>Ïø†Ìè∞ Ï†ïÏ±Ö</th>
                                <td>
                                    <select class="form-control" name="couponPolicyId" required>
                                        <option value="none" disabled selected>ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</option>
                                        <option th:each="policy : ${couponPolicies}"
                                                th:value="${policy.couponPolicyId}"
                                                th:text="${policy.couponPolicyName + ' (' + #temporals.format(policy.couponPolicyCreatedAt, 'yyyy-MM-dd') + ')'}">
                                        </option>
                                    </select>
                                </td>
                            </tr>

                            <!-- Ïø†Ìè∞ Ï¢ÖÎ•ò -->
                            <tr>
                                <th>Ïø†Ìè∞ Ï¢ÖÎ•ò</th>
                                <td>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="couponType" id="typeTotal" value="total" checked>
                                        <label class="form-check-label" for="typeTotal">Ï†ÑÏ≤¥ Ìï†Ïù∏ (ÏùºÎ∞ò, ÏÉùÏùº, Welcome)</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="couponType" id="typeCategory" value="category">
                                        <label class="form-check-label" for="typeCategory">Ïπ¥ÌÖåÍ≥†Î¶¨ Ìï†Ïù∏</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="couponType" id="typeProduct" value="product">
                                        <label class="form-check-label" for="typeProduct">ÎèÑÏÑú Ìï†Ïù∏</label>
                                    </div>
                                </td>
                            </tr>

                            <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù -->
                            <tr id="categoryRow" class="hidden">
                                <th>Ïπ¥ÌÖåÍ≥†Î¶¨</th>
                                <td>
                                    <!-- Ï°∞Ìöå ÏòÅÏó≠ -->
                                    <div class="row mb-5">
                                        <div class="col-12 category-dash">
                                            <ul id="categoryTree">
                                                <li th:each="category : ${categories}" class="mb-2">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <!-- Îì§Ïó¨Ïì∞Í∏∞ + ÌÖçÏä§Ìä∏ -->
                                                        <div class="category-left">
                                                            <div class="d-flex align-items-center">
                                                                <span class="toggle me-2" onclick="toggleClick(this)">üìÅ</span>
                                                                <span th:text="${category.categoryName}"></span>
                                                            </div>
                                                        </div>

                                                        <!-- Ïò§Î•∏Ï™Ω Î≤ÑÌäº -->
                                                        <div class="ms-2">
                                                            <button type="button"
                                                                    class="btn btn-sm btn-outline-success"
                                                                    th:attr="data-id=${category.categoryId}, data-name=${category.categoryName}"
                                                                    onclick="selectCategory(this)">ÏÑ†ÌÉù</button>
                                                        </div>
                                                    </div>

                                                    <!-- ÏûêÏãù Ïπ¥ÌÖåÍ≥†Î¶¨ -->
                                                    <ul th:if="${#lists.size(category.children) > 0}" class="ms-4 mt-2">
                                                        <th:block th:replace="admin/coupon/coupon-register-categoryFragment :: categoryFragment(category=${category})" />
                                                    </ul>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </td>
                            </tr>

                            <!-- ÏÑ†ÌÉùÌïú Ïπ¥ÌÖåÍ≥†Î¶¨ -->
                            <tr id="categoryRow2" class="hidden">
                                <th>ÏÑ†ÌÉùÌïú Ïπ¥ÌÖåÍ≥†Î¶¨</th>
                                <td>
                                    <span id="selectedCategoryName">ÏóÜÏùå</span>
                                    <input type="hidden" name="categoryId" id="selectedCategoryId" />
                                </td>
                            </tr>


                            <!-- ÎèÑÏÑú ÏÑ†ÌÉù -->
                            <tr id="productRow" class="hidden">
                                <th>ÎèÑÏÑú</th>
                                <td>
                                    <select class="form-control" name="productId" multiple size="8">
                                        <option th:each="product : ${products}" th:value="${product.id}" th:text="${product.name}">ÎèÑÏÑú</option>
                                    </select>
                                </td>
                            </tr>
                            </tbody>
                        </table>

                        <!-- Ï†úÏ∂ú Î≤ÑÌäº -->
                        <div class="text-center mt-4">
                            <button type="submit" class="button button-register w-100">REGISTER COUPON</button>
                        </div>
                    </form>

                    <!-- Ïä§ÌÅ¨Î¶ΩÌä∏ Î∞è Ïä§ÌÉÄÏùº -->
                    <script>
                        function selectCategory(button) {
                            const categoryId = button.getAttribute("data-id");
                            const categoryName = button.getAttribute("data-name");

                            // Í∞í ÌëúÏãú
                            document.getElementById("selectedCategoryName").textContent = categoryName;
                            document.getElementById("selectedCategoryId").value = categoryId;
                        }

                        // Ìèº Ï†úÏ∂ú Ïãú Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                        document.querySelector("form").addEventListener("submit", function (e) {
                            const couponType = document.querySelector("input[name='couponType']:checked").value;
                            const categoryId = document.getElementById("selectedCategoryId").value;
                            const couponPolicy = document.querySelector("select[name='couponPolicyId']");

                            // Ïø†Ìè∞ Ï†ïÏ±Ö ÏÑ†ÌÉù Í≤ÄÏÇ¨
                            if (couponPolicy.value === "none") {
                                e.preventDefault();
                                alert("Ïø†Ìè∞ Ï†ïÏ±ÖÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                                return;
                            }

                            // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù Ïïà Ìïú Í≤ΩÏö∞
                            if (couponType === "category" && !categoryId) {
                                e.preventDefault();
                                alert("Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                            }

                        });

                        document.addEventListener("DOMContentLoaded", () => {
                            const toggles = document.querySelectorAll("#categoryTree .toggle");

                            toggles.forEach(span => {
                                const li = span.closest("li");
                                const childUl = li.querySelector("ul");

                                if (!childUl) {
                                    span.textContent = "üîπ"; // ÏûêÏãùÏù¥ ÏóÜÎäî Í≤ΩÏö∞
                                } else {
                                    span.textContent = "üìÇ"; // Ï≤òÏùåÏóê Îã§ Ïó¥Ïñ¥ÏÑú Î≥¥Ïó¨Ï§å
                                    // childUl.style.display = "none"; // Í∏∞Î≥∏ÏùÄ Îã´Ìûå ÏÉÅÌÉú
                                }
                            });
                        });

                        document.addEventListener("DOMContentLoaded", function () {
                            const radios = document.querySelectorAll("input[name='couponType']");
                            const categoryRow = document.getElementById("categoryRow")
                            const categoryRow2 = document.getElementById("categoryRow2");
                            const productRow = document.getElementById("productRow");


                            function updateVisibility(value) {
                                categoryRow.classList.toggle("hidden", value !== "category");
                                categoryRow2.classList.toggle("hidden", value !== "category");
                                productRow.classList.toggle("hidden", value !== "product");
                            }

                            updateVisibility(document.querySelector("input[name='couponType']:checked").value);

                            radios.forEach(radio => {
                                radio.addEventListener("change", function () {
                                    updateVisibility(this.value);
                                });
                            });
                        });

                        function toggleClick(element) {
                            const parentLi = element.closest("li");
                            const childUl = parentLi.querySelector("ul");

                            if (childUl) {
                                const isVisible = childUl.style.display !== "none";
                                childUl.style.display = isVisible ? "none" : "block";
                                element.textContent = isVisible ? "üìÅ" : "üìÇ"; // Îã´ÌûòÏù¥Î©¥ üìÅ, Ïó¥Î¶ºÏù¥Î©¥ üìÇ
                            }
                        }
                    </script>


                    <style>
                        .hidden {
                            display: none;
                        }

                        select[multiple] {
                            height: 300px;
                        }

                        table th {
                            white-space: nowrap;
                            vertical-align: top;
                            text-align: left;
                        }
                    </style>

                </div>
            </div>

        </div>
    </section>
</div>
</body>
</html>
